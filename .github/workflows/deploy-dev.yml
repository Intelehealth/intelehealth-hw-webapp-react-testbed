name: ğŸš€ Deploy to Development

on:
  push:
    branches: [dev]
  workflow_dispatch:
  workflow_run:
    workflows: ['ğŸ” Pull Request Checks']
    types: [completed]
    branches: [dev]

env:
  NODE_VERSION: '22.18.0'
  DEPLOY_ENV: 'development'

jobs:
  deploy-dev:
    name: Deploy to Development Server
    runs-on: ubuntu-latest
    environment: development
    # Only run if PR checks passed or if triggered manually
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ğŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ—ï¸ Build for development
        run: yarn build
        env:
          VITE_APP_ENV: development
          VITE_API_URL: ${{ secrets.DEV_API_URL }}

      - name: ğŸ“Š Analyze bundle
        run: yarn analyze

      - name: ğŸ” Setup SSH Key
        run: |
          echo "ğŸ” Setting up SSH key for server access..."
          # Create .ssh directory
          mkdir -p ~/.ssh
          # Set proper permissions
          chmod 700 ~/.ssh
          # Write the private key to file
          echo "${{ secrets.DEV_SERVER_PEM_KEY }}" > ~/.ssh/dev_server.pem
          # Set proper permissions for the key file
          chmod 600 ~/.ssh/dev_server.pem
          # Add server to known hosts to avoid host key verification prompt
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… SSH key setup completed!"

      - name: ğŸ§ª Test Server Connection
        run: |
          echo "ğŸ§ª Testing connection to development server..."
          ssh -i ~/.ssh/dev_server.pem -o StrictHostKeyChecking=no ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} "echo 'Connection successful!'"
          echo "âœ… Server connection test passed!"

      - name: ğŸš€ Deploy to Development Server
        run: |
          echo "ğŸš€ Deploying to development server..."

          # Create deployment directory on server
          ssh -i ~/.ssh/dev_server.pem -o StrictHostKeyChecking=no ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} "
            mkdir -p ${{ secrets.DEV_DEPLOY_PATH }}/backup
            mkdir -p ${{ secrets.DEV_DEPLOY_PATH }}/current
          "

          # Backup current deployment (if exists)
          ssh -i ~/.ssh/dev_server.pem -o StrictHostKeyChecking=no ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} "
            if [ -d '${{ secrets.DEV_DEPLOY_PATH }}/current' ] && [ \"\$(ls -A ${{ secrets.DEV_DEPLOY_PATH }}/current)\" ]; then
              echo 'ğŸ“¦ Creating backup of current deployment...'
              cp -r ${{ secrets.DEV_DEPLOY_PATH }}/current/* ${{ secrets.DEV_DEPLOY_PATH }}/backup/ 2>/dev/null || true
              echo 'âœ… Backup created successfully!'
            else
              echo 'â„¹ï¸ No existing deployment to backup'
            fi
          "

          # Upload build files to server
          echo "ğŸ“¤ Uploading build files to server..."
          rsync -avz --delete -e "ssh -i ~/.ssh/dev_server.pem -o StrictHostKeyChecking=no" \
            dist/ \
            ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }}:${{ secrets.DEV_DEPLOY_PATH }}/current/

          # Set proper permissions on server
          ssh -i ~/.ssh/dev_server.pem -o StrictHostKeyChecking=no ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} "
            echo 'ğŸ”§ Setting proper permissions...'
            chmod -R 755 ${{ secrets.DEV_DEPLOY_PATH }}/current/
            chown -R ${{ secrets.DEV_SERVER_USER }}:${{ secrets.DEV_SERVER_USER }} ${{ secrets.DEV_DEPLOY_PATH }}/current/
            echo 'âœ… Permissions set successfully!'
          "

          # Update web server configuration (if needed)
          ssh -i ~/.ssh/dev_server.pem -o StrictHostKeyChecking=no ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} "
            echo 'ğŸŒ Updating web server configuration...'
            # Add your web server restart commands here
            # Example for Nginx:
            # sudo systemctl reload nginx
            # Example for Apache:
            # sudo systemctl reload apache2
            echo 'âœ… Web server configuration updated!'
          "

          echo "âœ… Development deployment completed successfully!"

      # - name: ğŸ§ª Post-Deployment Health Check
      #   run: |
      #     echo "ğŸ§ª Running post-deployment health checks..."
      #
      #     # Wait a moment for deployment to settle
      #     sleep 10
      #
      #     # Check if the application is responding
      #     HEALTH_CHECK_URL="${{ secrets.DEV_HEALTH_CHECK_URL }}"
      #     if [ -n "$HEALTH_CHECK_URL" ]; then
      #       echo "ğŸ” Checking application health at: $HEALTH_CHECK_URL"
      #       HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" || echo "000")
      #
      #       if [ "$HTTP_STATUS" = "200" ]; then
      #         echo "âœ… Health check passed! Application is responding correctly."
      #       else
      #         echo "âš ï¸ Health check failed with status: $HTTP_STATUS"
      #         echo "ğŸ” Checking server status..."
      #         ssh -i ~/.ssh/dev_server.pem -o StrictHostKeyChecking=no ${{ secrets.DEV_SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} "
      #           echo 'Server status:'
      #           ps aux | grep -E '(nginx|apache|node)' | grep -v grep || echo 'No web server processes found'
      #           echo 'Disk space:'
      #           df -h
      #           echo 'Recent logs:'
      #           tail -n 20 /var/log/nginx/error.log 2>/dev/null || echo 'No nginx error logs found'
      #         "
      #       fi
      #     else
      #       echo "â„¹ï¸ No health check URL configured, skipping health check"
      #     fi
      #
      #     echo "âœ… Post-deployment health check completed!"

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up temporary files..."
          # Remove the private key file for security
          rm -f ~/.ssh/dev_server.pem
          echo "âœ… Cleanup completed!"

      - name: ğŸ“§ Notify deployment
        if: always()
        run: |
          echo "ğŸ“§ Development deployment notification sent"
          # Add notification logic (Slack, email, etc.)
