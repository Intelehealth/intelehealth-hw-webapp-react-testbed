name: ðŸ“ Code Quality & Security

on:
  push:
    branches: [main, dev, qa, staging, feature/gh-actions]
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM

jobs:
  code-quality:
    name: Comprehensive Code Quality & Security Analysis
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - name: ðŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸ” ESLint analysis
        run: |
          echo "ðŸ” Running ESLint analysis..."
          yarn lint --format json --output-file eslint-report-${{ matrix.node-version }}.json || true

      - name: ðŸŽ¨ Prettier check
        run: |
          echo "ðŸŽ¨ Running Prettier check..."
          yarn format:check

      - name: ðŸ”§ TypeScript analysis
        run: |
          echo "ðŸ”§ Running TypeScript analysis..."
          yarn type-check

      - name: ðŸ§ª Run tests
        run: yarn test:run

      - name: ðŸ“Š Generate coverage report
        run: yarn test:coverage

      - name: ðŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

      - name: ðŸ—ï¸ Build verification
        run: yarn build

      - name: ðŸ“Š Bundle size analysis
        run: |
          echo "ðŸ“Š Analyzing bundle size..."
          yarn analyze

      - name: ðŸ“ˆ Performance budget check
        run: |
          echo "ðŸ“ˆ Checking performance budget..."
          BUNDLE_SIZE=$(du -sh dist/ | cut -f1)
          echo "Bundle size: $BUNDLE_SIZE"

          if [ -f "dist/assets" ]; then
            echo "âœ… Bundle size check completed"
          else
            echo "âŒ Bundle size check failed"
            exit 1
          fi

      - name: ðŸ”’ Security audit
        run: |
          echo "ðŸ” Running security audit..."
          yarn audit --level high
          npm audit --audit-level high

      - name: ðŸ” Check for secrets
        run: |
          echo "ðŸ” Checking for potential secrets..."
          if grep -r -i "password\|secret\|key\|token" src/ --exclude="*.test.*" --exclude="*.spec.*"; then
            echo "âš ï¸ Potential secrets found in source code"
            exit 1
          else
            echo "âœ… No secrets found in source code"
          fi

      - name: ðŸ” Check environment variables
        run: |
          echo "ðŸ” Checking environment variable usage..."
          if grep -r "process\.env\." src/ --exclude="*.test.*" --exclude="*.spec.*"; then
            echo "â„¹ï¸ Environment variables found in source code"
          else
            echo "âœ… No direct process.env usage found"
          fi

      - name: ðŸ” Dependency vulnerability scan
        run: |
          echo "ðŸ” Running dependency vulnerability scan..."
          npx audit-ci --config .audit-ci.json || true

      - name: ðŸ“ Generate quality report
        run: |
          echo "ðŸ“ Generating comprehensive quality report..."
          echo "# Code Quality & Security Report" > quality-report-${{ matrix.node-version }}.md
          echo "## Analysis Results" >> quality-report-${{ matrix.node-version }}.md
          echo "- ESLint: Completed" >> quality-report-${{ matrix.node-version }}.md
          echo "- Prettier: Completed" >> quality-report-${{ matrix.node-version }}.md
          echo "- TypeScript: Completed" >> quality-report-${{ matrix.node-version }}.md
          echo "- Unit Tests: Completed" >> quality-report-${{ matrix.node-version }}.md
          echo "- Bundle Analysis: Completed" >> quality-report-${{ matrix.node-version }}.md
          echo "- Security Audit: Completed" >> quality-report-${{ matrix.node-version }}.md
          echo "- Secrets Scan: Completed" >> quality-report-${{ matrix.node-version }}.md
          echo "- Dependency Scan: Completed" >> quality-report-${{ matrix.node-version }}.md

      - name: ðŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files-${{ matrix.node-version }}
          path: dist/
          retention-days: 7

      - name: ðŸ“Š Upload quality reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports-${{ matrix.node-version }}
          path: |
            eslint-report-${{ matrix.node-version }}.json
            quality-report-${{ matrix.node-version }}.md
            coverage/
          retention-days: 30

      - name: ðŸ“§ Notify security issues
        if: failure()
        run: |
          echo "ðŸš¨ Security or quality issues detected!"
          # Add notification logic for security/quality issues
