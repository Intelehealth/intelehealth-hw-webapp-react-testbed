name: ğŸ” Pull Request Checks

on:
  pull_request:
    branches: [main, dev, qa, staging, feature/gh-actions]
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    name: Comprehensive PR Quality Checks
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.18.0]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - name: ğŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ” ESLint analysis
        run: |
          echo "ğŸ” Running ESLint analysis..."
          yarn lint --format json --output-file eslint-report-${{ matrix.node-version }}.json || true

      - name: ğŸ¨ Prettier check
        run: |
          echo "ğŸ¨ Running Prettier check..."
          yarn format:check

      - name: ğŸ”§ TypeScript analysis
        run: |
          echo "ğŸ”§ Running TypeScript analysis..."
          yarn type-check

      - name: ğŸ§ª Run tests
        run: yarn test:run

      - name: ğŸ“Š Generate coverage report
        run: yarn test:coverage

      - name: ğŸ“Š Check coverage threshold
        run: |
          echo "ğŸ” Checking coverage threshold..."
          COVERAGE=$(grep -o '"lines":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9.]*}' coverage/coverage-summary.json | grep -o '"pct":[0-9.]*' | cut -d':' -f2)
          echo "Current coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 100" | bc -l) )); then
            echo "âŒ Coverage is ${COVERAGE}%, but 100% is required"
            exit 1
          else
            echo "âœ… Coverage is ${COVERAGE}% - meets 100% requirement"
          fi

      - name: ğŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      - name: ğŸ—ï¸ Build verification
        run: yarn build

      - name: ğŸ“Š Bundle analysis
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          yarn analyze

      - name: ğŸ“ˆ Performance budget check
        run: |
          echo "ğŸ“ˆ Checking performance budget..."

          # Get bundle size in KB
          BUNDLE_SIZE_KB=$(du -sk dist/ | cut -f1)
          BUNDLE_SIZE_MB=$((BUNDLE_SIZE_KB / 1024))
          BUNDLE_SIZE_DISPLAY=$(du -sh dist/ | cut -f1)

          echo "Bundle size: $BUNDLE_SIZE_DISPLAY ($BUNDLE_SIZE_KB KB)"

          # Set performance budget (2MB = 2048KB)
          MAX_SIZE_KB=2048

          if [ $BUNDLE_SIZE_KB -le $MAX_SIZE_KB ]; then
            echo "âœ… Bundle size check passed ($BUNDLE_SIZE_KB KB <= $MAX_SIZE_KB KB)"
          else
            echo "âŒ Bundle size check failed ($BUNDLE_SIZE_KB KB > $MAX_SIZE_KB KB)"
            echo "ğŸ’¡ Consider optimizing your bundle size"
            exit 1
          fi

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ” Running security audit..."
          echo "Checking for high-level vulnerabilities only..."
          yarn audit --level high || echo "âš ï¸ High-level vulnerabilities found - check audit output above"
          npm audit --audit-level high || echo "âš ï¸ High-level vulnerabilities found - check audit output above"

      - name: ğŸ” Check for secrets
        run: |
          echo "ğŸ” Checking for potential secrets..."
          if grep -r -i "password\|secret\|key\|token" src/ --exclude="*.test.*" --exclude="*.spec.*"; then
            echo "âš ï¸ Potential secrets found in source code"
            exit 1
          else
            echo "âœ… No secrets found in source code"
          fi

      - name: ğŸ” Dependency vulnerability scan
        run: |
          echo "ğŸ” Running dependency vulnerability scan..."
          npx audit-ci --config .audit-ci.json || true

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files-${{ matrix.node-version }}
          path: dist/
          retention-days: 7

      - name: ğŸ“Š Upload quality reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports-${{ matrix.node-version }}
          path: |
            eslint-report-${{ matrix.node-version }}.json
            coverage/
          retention-days: 30

      - name: ğŸ“ Comment PR with results
        if: matrix.node-version == '20'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read coverage report if it exists
            let coverageComment = '';
            try {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const totalCoverage = coverage.total.lines.pct;
              const coverageStatus = totalCoverage >= 100 ? 'âœ…' : 'âŒ';
              coverageComment = `\n\n## ğŸ“Š Coverage Report\n- **Total Coverage**: ${totalCoverage}% ${coverageStatus}\n- **Lines**: ${coverage.total.lines.covered}/${coverage.total.lines.total}\n- **Functions**: ${coverage.total.functions.covered}/${coverage.total.functions.total}\n- **Branches**: ${coverage.total.branches.covered}/${coverage.total.branches.total}\n- **Requirement**: 100% coverage required`;
            } catch (e) {
              coverageComment = '\n\n## ğŸ“Š Coverage Report\nCoverage data not available';
            }

            const comment = `## âœ… PR Quality Checks Completed

            All quality checks have passed successfully! ğŸ‰

            **Checks Performed:**
            - âœ… ESLint analysis
            - âœ… Prettier formatting
            - âœ… TypeScript type checking
            - âœ… Unit tests (Node ${{ matrix.node-version }})
            - âœ… Build verification
            - âœ… Bundle analysis
            - âœ… Performance budget check
            - âœ… Security audit
            - âœ… Secrets scan
            - âœ… Dependency vulnerability scan
            ${coverageComment}

            **Ready for review!** ğŸ‘€`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
